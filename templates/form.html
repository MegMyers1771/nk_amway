<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞–∫–ª–∞–¥–Ω–∞—è</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <style>
        .form-section { margin-bottom: 2rem; }
        .item-row { margin-bottom: 1rem; }
        .form-control:focus { box-shadow: none; }
        .warehouse-labels { font-size: 0.8rem; color: #888; }
        .spinner-border-sm { width: 1rem; height: 1rem; }
    </style>
</head>

<body class="bg-light">
<div class="container py-4 px-2">
    <h2 class="mb-4">–°–æ–∑–¥–∞–Ω–∏–µ –Ω–∞–∫–ª–∞–¥–Ω–æ–π</h2>
    <form method="post">
        <div class="row form-section">
            <div class="col-6 col-md-2">
                <label class="form-label">–ù–æ–º–µ—Ä</label>
                <input class="form-control" name="invoice_number" type="number" value="{{ settings.invoice_number }}">
            </div>
            <div class="col-6 col-md-3">
                <label class="form-label">–î–∞—Ç–∞</label>
                <input class="form-control" name="date" type="date" value="{{ settings.date }}">
            </div>
            <div class="col-6 col-md-3">
                <label class="form-label">–ú–µ–Ω–µ–¥–∂–µ—Ä</label>
                <input class="form-control" name="manager" value="{{ settings.manager }}">
            </div>
            <div class="col-6 col-md-4">
                <label class="form-label">–ü–æ–∫—É–ø–∞—Ç–µ–ª—å</label>
                <input class="form-control" name="buyer" value="{{ settings.buyer }}">
            </div>
        </div>

        <div class="row form-section">
            <div class="col-md-6">
                <label class="form-label">–ê–¥—Ä–µ—Å</label>
                <input class="form-control" name="address" value="{{ settings.address }}">
            </div>
            <div class="col-md-6">
                <label class="form-label">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</label>
                <input class="form-control" name="payment_method" value="{{ settings.payment_method }}">
            </div>
        </div>

        <h4 class="mb-3">–ù–∞–∫–ª–∞–¥–Ω–∞—è</h4>
        <div id="items"></div>

        <button type="button" class="btn btn-outline-primary my-2" id="add-item">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>

        <div class="mt-4">
            <button class="btn btn-success" type="submit">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–∫–ª–∞–¥–Ω—É—é</button>
        </div>
    </form>

    <div class="mt-4">
        <button id="load-warehouse" class="btn btn-primary mb-3">
            <span id="warehouse-loader" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
            –ü–æ–¥–≥—Ä—É–∑–∏—Ç—å —Å–∫–ª–∞–¥
        </button>
    </div>
    <div class="col-md-12 mt-3 d-flex align-items-end">
        <div class="flex-grow-1 me-2">
            <label class="form-label">–°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–∞–±–ª–∏—Ü—É</label>
            <input class="form-control" id="invoice-link" value="{{ settings.invoice_link }}">
        </div>
        <button type="button" class="btn btn-outline-success mb-1" id="save-link">üíæ</button>
    </div>
</div>

<!-- JS –∏ jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

<script>
    let warehouseData = [];

    function createItemRow() {
        const row = document.createElement("div");
        row.className = "row item-row align-items-end";
        row.innerHTML = `
            <div class="col-6 col-md-2">
                <input class="form-control" name="article" placeholder="–ê—Ä—Ç–∏–∫—É–ª">
            </div>
            <div class="col-6 col-md-4">
                <input class="form-control item-name" name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
                <div class="warehouse-labels">
                    <span class="stock-label">–°–∫–ª–∞–¥: ‚Äî</span> | 
                    <span class="price-label">–¶–µ–Ω–∞: ‚Äî</span>
                </div>
            </div>
            <div class="col-6 col-md-2">
                <input class="form-control" name="quantity" placeholder="–ö–æ–ª-–≤–æ" type="number" required>
            </div>
            <div class="col-6 col-md-2">
                <input class="form-control" name="price" placeholder="–¶–µ–Ω–∞" type="number" step="0.01" required>
            </div>
            <div class="col-12 col-md-2 text-end mt-2 mt-md-0">
                <button type="button" class="btn btn-danger remove-item">‚àí</button>
            </div>
        `;
        return row;
    }

    function bindAutocomplete(input) {
        $(input).autocomplete({
            source: warehouseData.map(item => item.name),
            select: function(event, ui) {
                const selectedItem = warehouseData.find(i => i.name === ui.item.value);
                const row = $(this).closest(".item-row");

                if (selectedItem) {
                    row.find("input[name='price']").val(selectedItem.price);
                    row.find("input[name='quantity']").val(1);
                    row.find(".stock-label").text("–°–∫–ª–∞–¥: " + selectedItem.quantity);
                    row.find(".price-label").text("–¶–µ–Ω–∞: " + selectedItem.price + "–†");
                }
            }
        });
    }

    $(document).ready(function() {
        // –ü–æ–¥–≥—Ä—É–∑–∫–∞ —Å–∫–ª–∞–¥–∞
        $("#load-warehouse").click(function (e) {
            e.preventDefault();
            $("#warehouse-loader").removeClass("d-none");

            $.get("/update_warehouse", function () {
                alert("‚úÖ –°–∫–ª–∞–¥ –æ–±–Ω–æ–≤–ª–µ–Ω!");
                location.reload();
            }).fail(function(jqXHR, textStatus, errorThrown) {
                alert("‚ùå –û—à–∏–±–∫–∞: " + textStatus + " " + errorThrown);
            }).always(() => {
                $("#warehouse-loader").addClass("d-none");
            });
        });

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å–∫–ª–∞–¥–∞
        $.getJSON("/warehouse", function(data) {
            warehouseData = data;
        });

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
        $("#add-item").on("click", function () {
            const row = createItemRow();
            document.getElementById("items").appendChild(row);
            bindAutocomplete($(row).find(".item-name"));
        });

        // –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
        document.addEventListener("click", function (e) {
            if (e.target.classList.contains("remove-item")) {
                e.target.closest(".item-row").remove();
            }
        });
    });
    $("#save-link").click(function () {
        const link = $("#invoice-link").val();
        $.ajax({
            url: "/save_invoice_link",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({ invoice_link: link }),
            success: function () {
                alert("‚úÖ –°—Å—ã–ª–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!");
            },
            error: function () {
                alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.");
            }
        });
    });

</script>
</body>
</html>
